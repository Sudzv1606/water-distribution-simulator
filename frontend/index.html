<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Smart Water Digital Twin</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

	<!-- Map and Chart Libraries -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

	<link rel="stylesheet" href="css/styles.css" />
	<link rel="stylesheet" href="css/map.css" />
	<script>
		// Debug script to run immediately
		console.log('üöÄ Page loading, checking elements...');

		// Check if elements exist right away
		function checkElements() {
			const modeToggle = document.getElementById('modeToggle');
			const monitoringView = document.getElementById('monitoringView');
			const simulationView = document.getElementById('simulationView');

			console.log('üîç Element check:', {
				modeToggle: !!modeToggle,
				monitoringView: !!monitoringView,
				simulationView: !!simulationView,
				modeToggleText: modeToggle ? modeToggle.textContent : 'N/A',
				monitoringDisplay: monitoringView ? monitoringView.style.display : 'N/A',
				simulationDisplay: simulationView ? simulationView.style.display : 'N/A'
			});

			return { modeToggle, monitoringView, simulationView };
		}

		// Check immediately
		checkElements();

		// Check again when DOM is ready
		document.addEventListener('DOMContentLoaded', () => {
			console.log('üìã DOM Content Loaded');
			checkElements();
		});

		// Check when everything is loaded
		window.addEventListener('load', () => {
			console.log('‚ö° Window fully loaded');
			const elements = checkElements();

			// Set up APP.JS handler override after page loads
			if (elements.modeToggle && elements.monitoringView && elements.simulationView) {
				console.log('‚úÖ All elements found, APP.JS should handle the toggle');

				// Confirm APP.JS handler is working
				console.log('üß™ Current mode:', window.currentMode || 'not set');
				console.log('üß™ Mode toggle onclick:', typeof elements.modeToggle.onclick);

				// Test if APP.JS handler exists
				if (typeof elements.modeToggle.onclick === 'function') {
					console.log('‚úÖ APP.JS handler is properly attached');
				} else {
					console.log('‚ùå APP.JS handler not attached');
				}
			} else {
				console.error('‚ùå Some elements still missing after page load');
			}
		});
	</script>
</head>
<body>
	<div class="container">
		<header class="app-header">
			<div class="brand">Aquasense Engineering</div>
			<div class="header-controls">
				<button id="modeToggle" class="btn mode-toggle">Switch to Simulation Mode</button>
				<div class="status pill" id="status">Disconnected</div>
			</div>
		</header>

		<!-- Monitoring View (Default) - Clean dashboard focus -->
		<div id="monitoringView">
			<section class="kpis">
				<div class="kpi">
					<div class="kpi-label">Spectral Frequency (S1)</div>
					<div class="kpi-value" id="kpiSpectral">--</div>
				</div>
				<div class="kpi">
					<div class="kpi-label">RMS Power</div>
					<div class="kpi-value" id="kpiRMS">--</div>
				</div>
			</section>

			<section class="grid">
				<div class="panel shadow">
					<h3>Spectral Frequency</h3>
					<canvas id="spectralChart" height="140"></canvas>
				</div>
				<div class="panel shadow">
					<h3>Kurtosis & Skewness</h3>
					<canvas id="statsChart" height="140"></canvas>
				</div>
				<div class="panel shadow">
					<h3>RMS Power</h3>
					<canvas id="rmsChart" height="140"></canvas>
				</div>
				<div class="panel shadow">
					<h3>Model Performance</h3>
					<div class="model-scores">
						<div class="score-item">
							<span class="score-label">Accuracy:</span>
							<span class="score-value" id="accScore">--</span>
						</div>
						<div class="score-item">
							<span class="score-label">Precision:</span>
							<span class="score-value" id="precScore">--</span>
						</div>
						<div class="score-item">
							<span class="score-label">Recall:</span>
							<span class="score-value" id="recScore">--</span>
						</div>
						<div class="score-item">
							<span class="score-label">AUC:</span>
							<span class="score-value" id="aucScore">--</span>
						</div>
					</div>
				</div>

			</section>

			<!-- üìà AUC Graph Section -->
			<section class="auc-section">
				<div id="auc-graph-container"></div>
			</section>

			<div id="alert" class="alert"></div>
			<pre id="log" class="log"></pre>
		</div>

		<!-- üåü EPANET-Style Network Visualization - Full Map + Bottom Panel Layout -->
		<div id="simulationView" style="display: none;">
			<!-- üè≠ Full-Screen Map Container -->
			<div class="map-container">
				<canvas id="epanetCanvas" width="1200" height="800"></canvas>

				<!-- üéØ Floating UI Elements -->
				<div class="floating-controls">
					<div class="search-box">
						<input type="text" placeholder="Search nodes/pipes..." class="search-input">
					</div>
					<div class="status-chip">
						<span class="status-indicator"></span>
						<span class="status-text">Live</span>
					</div>
				</div>

				<!-- üí¨ Pipe Information Tooltip -->
				<div id="pipeTooltip" class="pipe-tooltip">
					<div class="tooltip-header">
						<div class="tooltip-title">
							<span class="tooltip-icon">üö∞</span>
							<span class="tooltip-pipe-id">PIPE: --</span>
						</div>
						<div class="tooltip-subtitle" id="tooltipPipeName">Pipe Name</div>
						<button class="tooltip-close-btn" onclick="hidePipeTooltip()" title="Close">√ó</button>
					</div>

					<div class="tooltip-section">
						<div class="section-header">
							<span class="section-icon">üåä</span>
							<span class="section-title">HYDRAULIC DATA</span>
						</div>
						<div class="section-content">
							<div class="data-row">
								<span class="data-label">Length:</span>
								<span class="data-value" id="tooltipLength">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Diameter:</span>
								<span class="data-value" id="tooltipDiameter">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Material:</span>
								<span class="data-value" id="tooltipMaterial">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Flow:</span>
								<span class="data-value" id="tooltipFlow">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Velocity:</span>
								<span class="data-value" id="tooltipVelocity">--</span>
							</div>
						</div>
					</div>

					<div class="tooltip-section">
						<div class="section-header">
							<span class="section-icon">üîä</span>
							<span class="section-title">ACOUSTIC / DSP</span>
						</div>
						<div class="section-content">
							<div class="data-row">
								<span class="data-label">Spectral Freq:</span>
								<span class="data-value" id="tooltipSpectral">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">RMS Power:</span>
								<span class="data-value" id="tooltipRMS">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Signal Quality:</span>
								<span class="data-value" id="tooltipSignalQuality">--</span>
							</div>
						</div>
					</div>

					<div class="tooltip-section">
						<div class="section-header">
							<span class="section-icon">ü§ñ</span>
							<span class="section-title">AI MODEL STATUS</span>
						</div>
						<div class="section-content">
							<div class="data-row">
								<span class="data-label">Leak Probability:</span>
								<span class="data-value" id="tooltipLeakProb">--</span>
							</div>
							<div class="data-row">
								<span class="data-label">Anomaly Score:</span>
								<span class="data-value" id="tooltipAnomaly">--</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- üéõÔ∏è Bottom Sliding Panel -->
			<div class="bottom-panel">
					<div class="panel-header">
					<div class="panel-tabs">
						<button class="tab active">Scenario Controls</button>
						<button class="tab">Hydraulic Data</button>
					</div>
					<button class="panel-toggle-btn" id="panelToggleBtn" title="Toggle Panel">
						<span class="toggle-icon">‚èµ</span>
					</button>
				</div>

				<div class="panel-content">
					<!-- Scenario Controls Tab -->
					<div class="tab-content active" id="scenarioTab">
						<div class="controls-grid">
							<!-- üö∞ Enhanced Leak Simulation Section -->
							<div class="control-card">
								<h3>üö∞ Leak Simulation</h3>
								<div class="control-group">
									<label>Pipe Selector:</label>
									<select id="simPipeSelect" class="pipe-selector">
										<option value="P1">P1 - Main Supply Line</option>
										<option value="P2">P2 - Distribution Branch</option>
										<option value="P3">P3 - Service Connection</option>
										<option value="P4">P4 - Secondary Line</option>
										<option value="P5">P5 - Transfer Line</option>
									</select>
								</div>
								<div class="control-group">
									<label>Leak Severity:</label>
									<div class="slider-container">
										<input id="simLeakSev" type="range" min="0" max="1" step="0.1" value="0.5" class="severity-slider" />
										<span id="simLeakValue" class="slider-value">0.5</span>
									</div>
								</div>

								<div class="control-group">
									<button id="simLeakBtn" class="btn btn-danger">üíß Inject Leak</button>
									<button id="simClearLeakBtn" class="btn btn-secondary">üßπ Clear All</button>
								</div>
							</div>

							<!-- üè≠ Faulty Pipeline Status Card -->
							<div class="control-card">
								<h3>üè≠ Faulty Pipeline Status</h3>
								<div class="control-group">
									<label>Pipeline ID:</label>
									<div class="pipeline-display" id="faultyPipelineId">--</div>
								</div>
								<div class="control-group">
									<label>Leak Confidence:</label>
									<div class="confidence-display">
										<div class="confidence-bar-small">
											<div class="confidence-fill-small" id="faultyPipelineConfidence" style="width: 0%"></div>
										</div>
										<span class="confidence-text" id="faultyPipelineConfidenceText">0%</span>
									</div>
								</div>
							</div>

							<!-- üë∑ Contractor Assignment Card -->
							<div class="control-card">
								<h3>üë∑ Contractor Assignment</h3>
								<div class="control-group">
									<label>Assign Contractor:</label>
									<select id="contractorSelect" class="contractor-selector">
										<option value="">Select Contractor...</option>
										<option value="contractor1">AquaFix Solutions</option>
										<option value="contractor2">PipeMaster Pro</option>
										<option value="contractor3">HydroTech Services</option>
										<option value="contractor4">FlowGuard Engineers</option>
										<option value="contractor5">WaterWorks Specialists</option>
									</select>
								</div>
								<div class="control-group">
									<button id="assignContractorBtn" class="btn btn-primary">üìã Assign Task</button>
								</div>
							</div>


						</div>
					</div>

					<!-- Hydraulic Data Tab -->
					<div class="tab-content" id="hydraulicTab">
						<div class="data-grid">
							<div class="metric-card">
								<h4>üìä Real-time Pressure Gauges</h4>
								<div class="metric-grid">
									<div class="metric-item">
										<span class="metric-label">Node P1</span>
										<span class="metric-value" id="hydP1">-- psi</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Node P2</span>
										<span class="metric-value" id="hydP2">-- psi</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Node P3</span>
										<span class="metric-value" id="hydP3">-- psi</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Node P4</span>
										<span class="metric-value" id="hydP4">-- psi</span>
									</div>
								</div>
							</div>
							<div class="metric-card">
								<h4>ÔøΩ Flow Rate Monitoring</h4>
								<div class="metric-grid">
									<div class="metric-item">
										<span class="metric-label">Pipe F1</span>
										<span class="metric-value" id="hydF1">-- L/s</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Pipe F2</span>
										<span class="metric-value" id="hydF2">-- L/s</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Pipe F3</span>
										<span class="metric-value" id="hydF3">-- L/s</span>
									</div>
									<div class="metric-item">
										<span class="metric-label">Pipe F4</span>
										<span class="metric-value" id="hydF4">-- L/s</span>
									</div>
								</div>
							</div>
						</div>
					</div>




				</div>
			</div>
		</div>
	</div>
	<script src="js/sensor-data.js"></script>
	<script src="js/map.js"></script>
	<script src="js/auc-graph.js"></script>
	<script src="js/app.js"></script>
</body>
</html>
